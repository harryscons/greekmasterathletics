<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Greek Master Athletics Statistics</title>
    <!-- Robust Global Error Handler -->
    <script>
        window.onerror = function (msg, url, line, col, error) {
            var errorMessage = "üî• CRITICAL ERROR: " + msg + "\nLocation: " + url + ":" + line + ":" + col;
            console.error(errorMessage, error);
            alert(errorMessage + "\n\nPlease report this issue.");
            return false;
        };
    </script>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- Firebase SDK (Compat Version) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <!-- Theme initialization script moved to body to avoid TypeError -->
</head>

<body>
    <script>
        // Immediate Theme Application to prevent flicker
        (function () {
            const savedTheme = localStorage.getItem('tf_theme') || 'theme-default';
            if (document.body) {
                document.body.className = savedTheme;
            } else {
                // Fallback for extremely early execution
                window.addEventListener('DOMContentLoaded', () => {
                    document.body.className = savedTheme;
                });
            }
        })();
    </script>
    <div id="initial-loading-overlay"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-dark); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease, visibility 0.5s ease;">
        <div class="spinner"
            style="width: 50px; height: 50px; border: 5px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite;">
        </div>
        <h2 style="margin-top: 20px; color: var(--text-main); font-family: var(--font-stack);">Greek Master Athletics
        </h2>
        <p style="color: var(--text-muted); font-family: var(--font-stack);">Synchronizing Data...</p>
    </div>
    <div class="background-glow"></div>

    <div class="app-container">
        <header>
            <!-- TOP BAR: Auth (Left), Logo (Center), Cloud/Save (Right) -->
            <div class="top-bar"
                style="display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; width: 100%; gap: 1rem; margin-bottom: 0.25rem;">

                <!-- Auth UI (Left) -->
                <div id="authSection" style="display: flex; align-items: center; gap: 0.5rem; justify-self: start;">
                    <button id="btnLogin" class="btn-small"
                        style="background: var(--primary); color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem;">
                        üîê Admin Login
                    </button>
                    <div id="userProfile" class="hidden" style="display: flex; align-items: center; gap: 0.5rem;">
                        <img id="userAvatar" src="" alt="User"
                            style="width: 28px; height: 28px; border-radius: 50%; border: 2px solid var(--primary);">
                        <button id="btnLogout" class="btn-text"
                            style="color: var(--text-muted); font-size: 0.8rem; text-decoration: underline; cursor: pointer; background: none; border: none;">
                            Logout
                        </button>
                    </div>
                </div>

                <!-- Logo Container (Center) -->
                <div style="display:flex; flex-direction:column; align-items:center; text-align:center;">
                    <div class="logo-container">
                        <div class="logo-icon">
                            <svg width="40" height="40" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg"
                                style="border-radius: 50%; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); transform: translateY(4px); overflow: hidden;">
                                <rect width="18" height="18" fill="#005BAE" />
                                <g stroke="#fff" stroke-width="2">
                                    <line x1="0" y1="3" x2="18" y2="3" />
                                    <line x1="0" y1="7" x2="18" y2="7" />
                                    <line x1="0" y1="11" x2="18" y2="11" />
                                    <line x1="0" y1="15" x2="18" y2="15" />
                                </g>
                                <rect width="10" height="10" fill="#005BAE" />
                                <g stroke="#fff" stroke-width="2">
                                    <line x1="5" y1="0" x2="5" y2="10" />
                                    <line x1="0" y1="5" x2="10" y2="5" />
                                </g>
                            </svg>
                        </div>
                        <h1>GREEK MASTER ATHLETICS STATISTICS</h1>
                    </div>
                    <p class="subtitle"
                        style="font-size: 1.05rem; font-weight: 500; letter-spacing: 1px; color: var(--accent); margin-top: 0; transition: color 0.3s ease;">
                        Powered by Team of Greekatheletics.gr
                    </p>
                </div>

                <!-- Cloud Status & Save (Right) -->
                <div style="display: flex; align-items: center; gap: 0.5rem; justify-self: end;">
                    <div id="cloudStatus" title="Cloud Sync Status"
                        style="display: flex; align-items: center; gap: 0.5rem; background: var(--bg-hover); padding: 0.4rem 0.8rem; border-radius: 20px; border: 1px solid var(--border); font-size: 0.85rem; font-weight: 600; color: var(--text-main);">
                        <span id="cloudIcon"
                            style="color: #ef4444; font-size: 1.2rem; transform: translateY(1px); display: inline-block;">‚óè</span>
                        <span id="cloudText">Cloud Offline</span>
                    </div>

                    <button id="btnSaveCloud" onclick="saveToCloud()" title="Save Changes to Cloud"
                        style="display: none; align-items: center; gap: 0.5rem; background: var(--success); color: white; padding: 0.4rem 0.8rem; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        <span style="font-size: 1rem;">‚òÅ</span>
                        <span>Save</span>
                    </button>
                </div>

            </div>

            <!-- Navigation Tabs -->
            <nav class="nav-tabs" style="margin-top: 0;">
                <button class="nav-tab active" data-tab="reports">Reports</button>
                <button class="nav-tab" data-tab="stats">Statistics</button>

                <button class="nav-tab" data-tab="history">Record History</button>
                <button class="nav-tab" data-tab="settings">Settings</button>
                <div class="nav-actions">
                </div>
            </nav>
        </header>

        <main>
            <!-- REPORTS VIEW (First/Default) -->
            <div id="view-reports" class="view-section active-view">
                <section class="card reports-section">
                    <div class="section-header">
                        <h2>Greek Master Track & Field Records</h2>
                        <span class="version-label">v2.20.12</span>
                    </div>

                    <div class="report-toolbar">
                        <div class="filters">
                            <select id="filterTrackType" title="Filter by Track Type (Outdoor/Indoor)">
                                <option value="all">All Track Types</option>
                                <option value="Outdoor" selected>Outdoor</option>
                                <option value="Indoor">Indoor</option>
                            </select>
                            <select id="filterEvent">
                                <option value="all">All Events</option>
                                <!-- Populated by JS -->
                            </select>
                            <select id="filterGender">
                                <option value="all">All Genders</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Mixed">Mixed</option>
                            </select>
                            <select id="filterAge">
                                <option value="all">All Age Groups</option>
                                <!-- Populated by JS -->
                            </select>
                            <select id="filterYear">
                                <option value="all">All Years</option>
                                <!-- Populated by JS -->
                            </select>
                            <select id="filterAthlete" title="Select Athlete">
                                <option value="all">All Athletes</option>
                                <!-- Populated by JS -->
                            </select>
                            <input type="text" id="filterAthleteName" placeholder="Search Name..." autocomplete="off"
                                style="width: 140px;">
                            <select id="filterAgeMismatch" title="Filter by Age Verification Status">
                                <option value="all">All Records</option>
                                <option value="issue" style="color:var(--danger); font-weight:bold;">With Age Issues
                                </option>
                                <option value="valid" style="color:var(--primary);">Verified OK</option>
                            </select>
                        </div>

                        <div class="actions-bar" style="display: flex; gap: 0.5rem; align-items: center;">
                            <button id="btnNewRecordInline" class="btn-small btn-icon" title="Log New Record"
                                onclick="openRecordModal()"
                                style="padding: 0.4rem; background: transparent; border: 1px solid var(--border); border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20px" height="20px"
                                    fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                            </button>
                            <div style="width: 1px; height: 24px; background: var(--border); margin: 0 0.25rem;"></div>

                            <button id="exportExcel" class="btn-small btn-icon" title="Export to MS Excel"
                                style="padding: 0.4rem; background: transparent; border: 1px solid var(--border); border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="20px" height="20px">
                                    <path fill="#4CAF50"
                                        d="M41,10H25v28h16c0.553,0,1-0.447,1-1V11C42,10.447,41.553,10,41,10z" />
                                    <path fill="#E8F5E9"
                                        d="M32,15h7v2.5h-7V15z M32,20h7v2.5h-7V20z M32,25h7v2.5h-7V25z M32,30h7v2.5h-7V30z" />
                                    <path fill="#2E7D32"
                                        d="M25,10h-2L6,13v22l17,3h2V10z M17.063,29l-2.071-4.708l-2.158,4.708H9.728l3.655-7.013l-3.321-6.987h3.048l1.791,4.407L16.883,15h3.181l-3.267,6.804L20.446,29H17.063z" />
                                </svg>
                            </button>
                            <button id="exportHTML" class="btn-small btn-icon" title="View as HTML Report"
                                style="padding: 0.4rem; background: transparent; border: 1px solid var(--border); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; min-width: 32px; min-height: 32px;">üåê</button>
                            <button id="exportPDF" class="btn-small btn-icon" title="Export to PDF"
                                style="padding: 0.4rem; background: transparent; border: 1px solid var(--border); border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20px" height="20px"
                                    fill="none" stroke="#F44336" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                    <path d="M10 14v4"></path>
                                    <path d="M10 16h2"></path>
                                    <path d="M10 18h2"></path>
                                    <path d="M16 14v4a2 2 0 0 0 2-2v-2"></path>
                                    <path d="M6 14v4"></path>
                                    <path d="M6 14h2a2 2 0 0 1 2 2v0a2 2 0 0 1-2 2H6"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table id="reportTable" class="report-table">
                            <thead>
                                <tr>
                                    <th class="expand-col" style="width: 40px;"></th>
                                    <th class="sortable" data-sort="event">ŒëŒ≥œéŒΩŒπœÉŒºŒ±</th>
                                    <th class="sortable" data-sort="ageGroup"
                                        style="width: 1%; white-space: nowrap; padding-left: 0.8rem; padding-right: 0.8rem;">
                                        ŒöŒ±œÑŒ∑Œ≥.</th>
                                    <th class="sortable" data-sort="athlete">ŒëŒ∏ŒªŒ∑œÑŒÆœÇ/œÑœÅŒπŒ±</th>
                                    <th class="sortable" data-sort="gender" style="width: 5%;">Œ¶œçŒªŒø</th>
                                    <th class="sortable" data-sort="mark" style="text-align: center;">ŒïœÄŒØŒ¥ŒøœÉŒ∑</th>
                                    <th class="sortable" data-sort="idr"
                                        style="width: 1%; white-space: nowrap; padding-left: 0.8rem; padding-right: 0.8rem;">
                                        IDR</th>
                                    <th class="sortable" data-sort="wind"
                                        style="width: 1%; white-space: nowrap; padding-left: 0.8rem; padding-right: 0.8rem;">
                                        ŒÜŒΩŒµŒºŒøœÇ</th>
                                    <th class="sortable" data-sort="date">ŒóŒºŒµœÅŒøŒºŒ∑ŒΩŒØŒ±</th>
                                    <th class="sortable" data-sort="town">Œ†œåŒªŒ∑</th>
                                    <th class="sortable" data-sort="raceName">ŒîŒπŒøœÅŒ≥Œ¨ŒΩœâœÉŒ∑</th>
                                    <th class="actions-col">ŒïŒΩŒ≠œÅŒ≥ŒµŒπŒµœÇ</th>
                                </tr>
                            </thead>
                            <tbody id="reportTableBody">
                                <!-- Rows injected here -->
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>

            <!-- RECORD MODAL (Log/Edit/Update) -->
            <div id="recordModal" class="modal-overlay hidden" style="z-index: 10000;">
                <div class="modal-content card"
                    style="max-width: 800px; width: 95%; max-height: 90vh; position: relative;">
                    <button class="modal-close" onclick="closeRecordModal()"
                        style="position: absolute; top: 1rem; right: 1rem; background: transparent; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; z-index: 10001;">&times;</button>

                    <!-- Form Section (Reused from view-log) -->
                    <section class="input-section" style="padding: 1rem 0;">
                        <h2 id="formTitle" style="margin-top: 0;">Log New Record</h2>
                        <form id="recordForm"
                            style="overflow-y: auto; max-height: calc(90vh - 120px); padding-right: 0.5rem;">
                            <!-- ... existing form content ... -->
                            <div class="row">
                                <div class="form-group">
                                    <label for="event">Event</label>
                                    <select id="event" required>
                                        <option value="" disabled selected>Select Event</option>
                                        <!-- Populated by JS -->
                                    </select>
                                </div>
                                <div class="form-group" id="athleteGroup">
                                    <label for="athlete" id="athleteLabel"
                                        style="display: flex; align-items: center; justify-content: flex-start; gap: 0.6rem; width: 100%;">
                                        <span class="label-main-text">Athlete Name</span>
                                        <div style="display: flex; gap: 4px;">
                                            <span id="athleteDobBadge" class="dob-badge hidden"></span>
                                        </div>
                                    </label>
                                    <select id="athlete" required>
                                        <option value="" disabled selected>Select Athlete</option>
                                        <!-- Populated by JS -->
                                    </select>
                                    <input type="text" id="relayTeamName" class="hidden" autocomplete="off">
                                </div>
                            </div>

                            <!-- Relay Participants Section -->
                            <div id="relayParticipantsSection" class="hidden"
                                style="margin-bottom: 1.5rem; background: var(--bg-nav); padding: 1.25rem; border-radius: 12px; border: 1px solid var(--border);">
                                <h4
                                    style="font-size: 0.9rem; color: var(--accent); margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.05em;">
                                    Relay Participants</h4>
                                <div class="row" style="gap: 1rem;">
                                    <div class="form-group" style="flex: 1;">
                                        <label style="font-size: 0.8rem; opacity: 0.8;">Athlete 1</label>
                                        <select id="relayAthlete1" class="relay-participant-select">
                                            <option value="">(Empty)</option>
                                        </select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label style="font-size: 0.8rem; opacity: 0.8;">Athlete 2</label>
                                        <select id="relayAthlete2" class="relay-participant-select">
                                            <option value="">(Empty)</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row" style="gap: 1rem; margin-top: 0.75rem;">
                                    <div class="form-group" style="flex: 1;">
                                        <label style="font-size: 0.8rem; opacity: 0.8;">Athlete 3</label>
                                        <select id="relayAthlete3" class="relay-participant-select">
                                            <option value="">(Empty)</option>
                                        </select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label style="font-size: 0.8rem; opacity: 0.8;">Athlete 4</label>
                                        <select id="relayAthlete4" class="relay-participant-select">
                                            <option value="">(Empty)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="form-group">
                                    <label for="gender">Gender</label>
                                    <select id="gender" required>
                                        <option value="" disabled selected>Select</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                        <option value="Mixed" id="optMixed" hidden disabled>Mixed</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="ageGroup" id="ageGroupLabel"
                                        style="display: flex; align-items: center; justify-content: flex-start; gap: 0.6rem; width: 100%;">
                                        <span class="label-main-text">Age Group</span>
                                        <span id="athleteAgeBadge" class="age-group-badge hidden"></span>
                                    </label>
                                    <select id="ageGroup" required>
                                        <!-- Populated by JS -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="trackType">Track Type</label>
                                    <select id="trackType" required>
                                        <option value="Outdoor" selected>Outdoor</option>
                                        <option value="Indoor">Indoor</option>
                                    </select>
                                </div>
                            </div>

                            <!-- NEW FIELDS: Race Name & Mark -->
                            <div class="row">
                                <div class="form-group" style="flex: 1.5;">
                                    <label for="raceName">Race Name</label>
                                    <input type="text" id="raceName" autocomplete="off">
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label for="mark">Mark (Time/Dist)</label>
                                    <input type="text" id="mark" required autocomplete="off">
                                </div>
                                <div class="form-group" style="flex: 0.4;">
                                    <label for="idr">IDR</label>
                                    <input type="text" id="idr" maxlength="2" autocomplete="off"
                                        style="text-align: center;">
                                </div>
                            </div>

                            <!-- Notes Field -->
                            <div class="row">
                                <div class="form-group">
                                    <label for="notes">Notes</label>
                                    <input type="text" id="notes" autocomplete="off">
                                </div>
                            </div>

                            <div class="row">
                                <div class="form-group">
                                    <label for="wind">Wind (+/-)</label>
                                    <input type="text" id="wind" autocomplete="off">
                                </div>
                                <div class="form-group">
                                    <label for="date">Date</label>
                                    <input type="date" id="date" required>
                                </div>
                            </div>

                            <div class="row">
                                <div class="form-group">
                                    <label for="town">Town</label>
                                    <input type="text" id="town" autocomplete="off">
                                </div>
                                <div class="form-group">
                                    <label for="country">Country</label>
                                    <select id="country">
                                        <option value="" disabled selected>Select Country</option>
                                        <!-- Populated by JS -->
                                    </select>
                                </div>
                            </div>

                            <!-- Inline Age Validation Warning -->
                            <div id="ageValidationWarning" class="hidden"
                                style="background: var(--bg-danger-light); border: 1px solid var(--danger); padding: 1rem; border-radius: 12px; margin-bottom: 1rem; color: var(--text-danger-light);">
                                <h4
                                    style="color: var(--danger); margin-bottom: 0.5rem; display:flex; align-items:center; gap:0.5rem;">
                                    ‚ö†Ô∏è Age Category Mismatch
                                </h4>
                                <p id="ageValidationMessage"
                                    style="font-size: 0.9rem; margin-bottom: 1rem; line-height: 1.4; color: #fca5a5;">
                                    <!-- Message injected via JS -->
                                </p>
                                <div style="display: flex; gap: 1rem;">
                                    <button type="button" id="btnAgeWarningProceed" class="btn-small"
                                        style="background: var(--danger); color: white; border: none;">
                                        Save Anyway
                                    </button>
                                    <button type="button" id="btnAgeWarningCancel" class="btn-small"
                                        onclick="document.getElementById('ageValidationWarning').classList.add('hidden')">
                                        Cancel & Correct
                                    </button>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="btn-primary" id="submitBtn">
                                    <span>Log Record</span>
                                    <div class="btn-shine"></div>
                                </button>
                                <button type="button" id="cancelBtn" class="btn-secondary hidden">Cancel</button>
                            </div>
                        </form>
                    </section>
                </div> <!-- End modal-content -->
            </div> <!-- End recordModal -->


            <!-- SETTINGS VIEW -->
            <div id="view-settings" class="view-section">
                <!-- Sub Navigation -->
                <div class="card" style="margin-bottom: 0.75rem; padding: 0.4rem; flex: none;">
                    <nav class="sub-nav">
                        <button class="sub-tab active" data-subtab="athletes">Athletes</button>
                        <button class="sub-tab" data-subtab="events">Events</button>
                        <button class="sub-tab" data-subtab="countries">Countries</button>
                        <button class="sub-tab" data-subtab="iaaf">IAAF Scoring Tables</button>
                        <button class="sub-tab" data-subtab="wma">WMA Conversion Tables</button>
                        <button class="sub-tab" data-subtab="general">General Settings</button>
                        <button id="subtab-users" class="sub-tab" data-subtab="users">Users</button>
                        <button class="sub-tab" data-subtab="data">Data Management</button>
                    </nav>
                </div>

                <!-- ATHLETES SUB-VIEW -->
                <div id="setting-athletes" class="setting-section setting-fill">
                    <section class="card">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; gap: 1rem;">
                            <div style="display: flex; flex-direction: column; min-width: 0;">
                                <h2
                                    style="margin-bottom: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    Manage Athletes</h2>
                                <p class="subtitle"
                                    style="margin-bottom: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    Add and manage athlete profiles.</p>
                            </div>
                            <button id="btnToggleAthleteForm" class="btn-primary"
                                style="padding: 0.5rem 1rem; font-size: 0.85rem; width: auto; flex: 0 0 auto;">
                                <span>‚ûï Add New Athlete</span>
                            </button>
                        </div>

                        <form id="athleteForm" class="hidden"
                            style="margin-bottom: 2rem; padding: 1.5rem; background: var(--bg-nav); border-radius: 12px; border: 1px solid var(--border);">
                            <div class="row">
                                <div class="form-group" style="flex: 1;">
                                    <label for="newAthleteFirstName">First Name</label>
                                    <input type="text" id="newAthleteFirstName" autocomplete="off">
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label for="newAthleteLastName">Last Name</label>
                                    <input type="text" id="newAthleteLastName" autocomplete="off">
                                </div>
                                <div class="form-group" style="flex: 0.5;">
                                    <label for="newAthleteID">ID # <span
                                            style="font-size: 0.75rem; color: var(--text-muted); font-weight: 400;">(Auto)</span></label>
                                    <input type="text" id="newAthleteID" readonly
                                        style="background: var(--bg-nav); cursor: not-allowed; opacity: 0.8; font-weight: 600; color: var(--primary);">
                                </div>
                            </div>

                            <div class="row">
                                <div class="form-group" style="flex: 1;">
                                    <label for="newAthleteDOB">Date of Birth</label>
                                    <input type="date" id="newAthleteDOB">
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label for="newAthleteGender">Gender</label>
                                    <select id="newAthleteGender" required>
                                        <option value="" disabled selected>Select</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Inline DOB Warning -->
                            <div id="athleteDobWarning" class="hidden"
                                style="background: var(--bg-danger-light); border: 1px solid var(--danger); padding: 1rem; border-radius: 12px; margin: 1rem 0; color: var(--text-danger-light);">
                                <p style="margin-bottom: 1rem; font-weight: 500;">
                                    Birth date is empty, athlete will be excluded for stats!
                                </p>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button type="button" id="btnProceedAthleteDob" class="btn-primary"
                                        style="font-size: 0.8rem; padding: 0.4rem 0.8rem; width: auto;">Proceed</button>
                                    <button type="button" id="btnCancelAthleteDob" class="btn-secondary"
                                        style="font-size: 0.8rem; padding: 0.4rem 0.8rem; width: auto;">Cancel</button>
                                </div>
                            </div>

                            <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                                <button type="submit" id="athleteSubmitBtn" class="btn-primary" style="flex: 1;">
                                    <span>+ Save Athlete</span>
                                </button>
                                <button type="button" id="btnCancelAthleteForm" class="btn-secondary" style="flex: 1;">
                                    <span>Cancel</span>
                                </button>
                            </div>
                        </form>

                        <div class="table-container">
                            <table class="report-table compact-table">
                                <thead>
                                    <tr>
                                        <th onclick="sortAthletes('idNumber')" style="cursor:pointer; width: 80px;">
                                            ID ‚Üï
                                        </th>
                                        <th onclick="sortAthletes('lastName')" style="cursor:pointer;">Last Name ‚Üï
                                        </th>
                                        <th onclick="sortAthletes('firstName')" style="cursor:pointer;">First Name ‚Üï
                                        </th>
                                        <th onclick="sortAthletes('dob')" style="cursor:pointer;">DOB ‚Üï</th>
                                        <th onclick="sortAthletes('gender')" style="cursor:pointer;">Gender ‚Üï</th>
                                        <th class="actions-col" style="width: 100px;">Actions</th>
                                    </tr>
                                    <tr class="filter-row" style="background: var(--bg-nav);">
                                        <th><input type="text" id="filterAthleteID" class="table-filter-input"
                                                placeholder="Search ID..." onclick="event.stopPropagation()"></th>
                                        <th><input type="text" id="filterAthleteLast" class="table-filter-input"
                                                placeholder="Search..." onclick="event.stopPropagation()"></th>
                                        <th><input type="text" id="filterAthleteFirst" class="table-filter-input"
                                                placeholder="Search..." onclick="event.stopPropagation()"></th>
                                        <th><input type="text" id="filterAthleteDOB" class="table-filter-input"
                                                placeholder="Search..." onclick="event.stopPropagation()"></th>
                                        <th>
                                            <select id="filterAthleteGender" class="table-filter-input"
                                                onclick="event.stopPropagation()">
                                                <option value="all">All</option>
                                                <option value="Male">Male</option>
                                                <option value="Female">Female</option>
                                            </select>
                                        </th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="athleteListBody">
                                    <!-- Athletes injected here -->
                                </tbody>
                            </table>
                        </div>
                    </section>
                </div>

                <!-- EVENTS SUB-VIEW -->
                <div id="setting-events" class="setting-section setting-fill hidden">
                    <section class="card">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <h2 style="margin: 0;">Manage Events</h2>
                            <button id="btnNewEvent" class="btn-primary"
                                style="margin: 0; padding: 0.5rem 1rem; border-radius: 8px;">+ New Event</button>
                        </div>
                        <p class="subtitle" style="margin-bottom: 1rem;">Add or remove event types available in the
                            dropdowns.</p>

                        <form id="eventForm" style="margin-bottom: 2rem; display: none;">
                            <div class="row">
                                <div class="form-group" style="flex: 2;">
                                    <label for="newEventName">Event Name</label>
                                    <input type="text" id="newEventName" placeholder="e.g. Decathlon" required
                                        autocomplete="off">
                                </div>
                                <div class="form-group" style="flex: 2;">
                                    <label for="newEventIAAF">IAAF Scoring Event</label>
                                    <select id="newEventIAAF">
                                        <option value="">None (No IAAF link)</option>
                                        <!-- Populated dynamically from IAAF data -->
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 2;">
                                    <label for="newEventWMA">WMA Conversion Event</label>
                                    <select id="newEventWMA">
                                        <option value="">None (No WMA link)</option>
                                        <!-- Populated dynamically from WMA data -->
                                    </select>
                                </div>
                                <div class="form-group"
                                    style="flex: 2; display: flex; flex-direction: column; gap: 0.5rem;">
                                    <label>Event Type</label>
                                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                        <label
                                            style="cursor: pointer; display: flex; align-items: center; gap: 0.3rem;">
                                            <input type="radio" name="eventType" value="Field" id="eventTypeField">
                                            Field
                                        </label>
                                        <label
                                            style="cursor: pointer; display: flex; align-items: center; gap: 0.3rem;">
                                            <input type="radio" name="eventType" value="Track" id="eventTypeTrack"
                                                checked> Track
                                        </label>
                                        <label
                                            style="cursor: pointer; display: flex; align-items: center; gap: 0.3rem;">
                                            <input type="radio" name="eventType" value="Road" id="eventTypeRoad">
                                            Road
                                        </label>
                                        <label
                                            style="cursor: pointer; display: flex; align-items: center; gap: 0.3rem;">
                                            <input type="radio" name="eventType" value="Combined"
                                                id="eventTypeCombined"> Combined
                                        </label>
                                        <label
                                            style="cursor: pointer; display: flex; align-items: center; gap: 0.3rem;">
                                            <input type="radio" name="eventType" value="Relay" id="eventTypeRelay">
                                            Relay
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group" style="flex: 1;" id="subEventCountGroup">
                                    <label for="newEventSubCount">Number of Events</label>
                                    <input type="number" id="newEventSubCount" min="2" max="20" disabled>
                                </div>
                            </div>

                            <div id="subEventsContainer" class="row"
                                style="flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; padding: 1rem; background: var(--bg-nav); border-radius: 12px; display: none;">
                                <!-- Dynamic Inputs -->
                            </div>

                            <div class="row" style="align-items: flex-end;">
                                <div class="form-group" style="flex: 1.2;">
                                    <label for="newEventSpecs">Technical Specs</label>
                                    <textarea id="newEventSpecs" rows="2"
                                        style="background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); padding: 0.5rem; border-radius: 8px; font-family: inherit; width: 100%; height: 62px; outline: none;"></textarea>
                                </div>
                                <div class="form-group" style="flex: 1; display: none;">
                                    <label for="newEventFormula">Parsing Formula</label>
                                    <textarea id="newEventFormula" rows="2"></textarea>
                                </div>
                                <div class="form-group" style="flex: 1.2;">
                                    <label for="newEventNotes">Notes</label>
                                    <textarea id="newEventNotes" rows="2"
                                        style="background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); padding: 0.5rem; border-radius: 8px; font-family: inherit; width: 100%; height: 62px; outline: none;"></textarea>
                                </div>
                                <div class="form-group"
                                    style="flex: 1.5; display: flex; flex-direction: column; gap: 0.5rem;">
                                    <label>&nbsp;</label>
                                    <div style="display: flex; flex-direction: row; gap: 0.5rem; align-items: stretch;">
                                        <button type="button" class="btn-secondary" id="openFormulaBtn"
                                            style="flex: 1; height: 62px; margin: 0; display: flex; align-items: center; justify-content: center; padding: 0;">
                                            <span>Formats</span>
                                        </button>
                                        <button type="submit" class="btn-primary" id="eventSubmitBtn"
                                            style="flex: 1.5; height: 62px; margin: 0; display: flex; align-items: center; justify-content: center; padding: 0;">
                                            <span>+ Add Event</span>
                                        </button>
                                        <button type="button" class="btn-secondary" id="btnCancelEvent"
                                            style="flex: 1; height: 62px; margin: 0; display: flex; align-items: center; justify-content: center; padding: 0;">
                                            <span>Cancel</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>

                        <div class="table-container">
                            <table class="report-table">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">Order</th>
                                        <th>Event Name</th>
                                        <th>Formula</th>
                                        <th>Tech Specs</th>
                                        <th>Notes</th>
                                        <th>IAAF / WMA Link</th>
                                        <th>Type</th>
                                        <th class="actions-col" style="width: 100px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="eventListBody" class="compact-rows">
                                    <!-- Events injected here -->
                                </tbody>
                            </table>
                        </div>
                    </section>
                </div>

                <!-- COUNTRIES SUB-VIEW -->
                <div id="setting-countries" class="setting-section setting-fill hidden">
                    <section class="card">
                        <h2>Manage Countries</h2>
                        <p class="subtitle" style="margin-bottom: 1rem;">Add or remove countries available in
                            the
                            dropdown.
                        </p>

                        <form id="countryForm"
                            style="margin-bottom: 2rem; display: flex; gap: 1rem; align-items: flex-end;">
                            <div class="form-group" style="flex: 3;">
                                <label for="newCountryName">Country Name</label>
                                <input type="text" id="newCountryName" required autocomplete="off">
                            </div>
                            <button type="submit" class="btn-primary" style="flex: 1;">
                                <span>+ Add Country</span>
                            </button>
                        </form>

                        <div class="table-container">
                            <table class="report-table">
                                <thead>
                                    <tr>
                                        <th>Country Name</th>
                                        <th class="actions-col" style="width: 100px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="countryListBody">
                                    <!-- Countries injected here -->
                                </tbody>
                            </table>
                        </div>
                    </section>
                </div>

                <!-- DATA SUB-VIEW -->
                <!-- IAAF CONVERSION TABLES SUB-VIEW -->
                <div id="setting-iaaf" class="setting-section setting-fill hidden">
                    <section class="card">
                        <h2>IAAF Scoring Tables</h2>
                        <p class="subtitle">Manage IAAF scoring coefficients for performance calculations.</p>
                        <div class="filter-bar"
                            style="margin-bottom: 2rem; display: flex; flex-direction: row; gap: 1rem; flex-wrap: wrap; align-items: flex-end;">
                            <!-- Category Filter -->
                            <div class="filter-group">
                                <label for="iaafFilterCategory">Category</label>
                                <select id="iaafFilterCategory" class="form-control" onchange="renderIAAFFilters()">
                                    <option value="outdoor" selected>Outdoor</option>
                                    <option value="indoor">Indoor</option>
                                </select>
                            </div>
                            <!-- Gender Filter -->
                            <div class="filter-group">
                                <label for="iaafFilterGender">Gender</label>
                                <select id="iaafFilterGender" class="form-control" onchange="renderIAAFFilters()">
                                    <option value="men">Men</option>
                                    <option value="women">Women</option>
                                </select>
                            </div>
                            <!-- Event Filter -->
                            <div class="filter-group" style="flex-grow: 1;">
                                <label for="iaafFilterEvent">Event</label>
                                <select id="iaafFilterEvent" class="form-control" onchange="renderIAAFTable()">
                                    <option value="" disabled selected>Select Event...</option>
                                </select>
                            </div>
                        </div>

                        <div id="iaafLoading" class="hidden"
                            style="text-align:center; padding:2rem; color:var(--text-muted);">
                            <div class="spinner"></div>
                            <p>Loading Scoring Tables...</p>
                        </div>

                        <div id="iaafTableContainer" class="table-container hidden">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th style="text-align: center;">Mark</th>
                                        <th>Points</th>
                                        <th style="width: 100px; text-align: center;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="iaafTableBody">
                                    <!-- Dynamic Content -->
                                </tbody>
                            </table>
                        </div>
                    </section>
                </div>

                <!-- WMA CONVERSION TABLES SUB-VIEW -->
                <div id="setting-wma" class="setting-section setting-fill hidden">
                    <section class="card">
                        <h2>WMA Conversion Tables</h2>
                        <p class="subtitle">Manage World Masters Athletics age-grading factors.</p>

                        <!-- WMA Filter Bar -->
                        <div class="filter-bar"
                            style="margin-bottom: 2rem; display: flex; flex-direction: row; gap: 1rem; flex-wrap: wrap; align-items: flex-end;">
                            <div class="filter-group">
                                <label for="wmaFilterGender">Gender</label>
                                <select id="wmaFilterGender" class="form-control" onchange="renderWMAFilters()">
                                    <option value="men">Men</option>
                                    <option value="women">Women</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="wmaFilterAgeGroup">Age Group</label>
                                <select id="wmaFilterAgeGroup" class="form-control" onchange="renderWMATable()">
                                    <option value="" disabled selected>Select Age Group...</option>
                                </select>
                            </div>
                            <div class="filter-group" style="flex-grow: 1;">
                                <label for="wmaFilterEvent">Event</label>
                                <select id="wmaFilterEvent" class="form-control" onchange="renderWMATable()">
                                    <option value="" disabled selected>Select Event...</option>
                                </select>
                            </div>
                            <button id="btnLoadOfficialWMA" class="btn-secondary"
                                style="height: 42px; width: auto; padding: 0 1.5rem; border-color: var(--accent); color: var(--accent);">
                                <span>üîÑ Reload Official 2023 Tables</span>
                            </button>
                        </div>

                        <!-- Add New Factor Form -->
                        <form id="wmaAddForm"
                            style="margin-bottom: 2rem; background: var(--bg-nav); padding: 1rem; border-radius: 12px; display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;">
                            <div class="form-group" style="flex: 1; min-width: 100px;">
                                <label for="newWMAAge">Age</label>
                                <input type="number" id="newWMAAge" required min="35" max="110">
                            </div>
                            <div class="form-group" style="flex: 1; min-width: 100px;">
                                <label for="newWMAFactor">Factor (0-1)</label>
                                <input type="number" id="newWMAFactor" required step="0.00001" min="0" max="1">
                            </div>
                            <button type="submit" class="btn-primary" style="height: 42px;">
                                <span>+ Add Factor</span>
                            </button>
                        </form>

                        <div id="wmaTableContainer" class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Age</th>
                                        <th>Factor</th>
                                        <th style="width: 120px; text-align: center;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="wmaTableBody">
                                    <!-- Dynamic Content -->
                                </tbody>
                            </table>
                        </div>
                    </section>
                </div>

                <!-- USERS SUB-VIEW -->
                <div id="setting-users" class="setting-section setting-fill hidden">
                    <section class="card">
                        <h2>Manage Users</h2>
                        <p class="subtitle" style="margin-bottom: 1rem;">Create and manage application users and
                            roles.</p>

                        <form id="userForm" style="margin-bottom: 2rem;">
                            <input type="hidden" id="editingUserId">
                            <div class="row">
                                <div class="form-group" style="flex: 1.5;">
                                    <label for="newUserName">Name</label>
                                    <input type="text" id="newUserName" required autocomplete="off">
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label for="newUserRole">Role</label>
                                    <select id="newUserRole" required>
                                        <option value="User">User</option>
                                        <option value="Admin">Admin</option>
                                        <option value="Supervisor">Supervisor</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1.5;">
                                    <label for="newUserEmail">Email</label>
                                    <input type="email" id="newUserEmail" required autocomplete="off">
                                </div>
                                <div class="form-actions" style="flex: 0.5; align-items: flex-end;">
                                    <button type="submit" id="userSubmitBtn" class="btn-primary"
                                        style="width: 100%; height: 42px;">Add</button>
                                </div>
                            </div>
                        </form>

                        <div class="table-container">
                            <table class="report-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Role</th>
                                        <th>Email</th>
                                        <th style="width: 100px; text-align: center;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="userListBody">
                                    <!-- Users injected here -->
                                </tbody>
                            </table>
                        </div>
                    </section>
                </div>

                <!-- GENERAL SETTINGS SUB-VIEW -->
                <div id="setting-general" class="setting-section setting-scroll hidden">
                    <section class="card">
                        <h2>General Settings</h2>
                        <p class="subtitle" style="margin-bottom: 2rem;">Configure application-wide preferences
                            and
                            appearance.</p>

                        <div class="row">
                            <div class="form-group" style="flex: 1; max-width: 400px;">
                                <label for="themeSelect">Color Theme</label>
                                <select id="themeSelect">
                                    <option value="theme-default">Default (Nebula)</option>
                                    <option value="theme-clean-white">Clean White (Light)</option>
                                    <option value="theme-mint-pale">Mint Pale (Pastel)</option>
                                    <option value="theme-rose-pale">Rose Pale (Pastel)</option>
                                    <option value="theme-sky-pale">Sky Pale (Pastel)</option>
                                    <option value="theme-lavender-pale">Lavender Pale (Pastel)</option>
                                    <option value="theme-lemon-pale">Lemon Pale (Pastel)</option>
                                </select>
                                <p class="help-text"
                                    style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">
                                    Select your
                                    preferred color palette for the application.</p>
                            </div>
                        </div>

                        <div class="row" style="margin-top: 1.5rem; flex-direction: column; gap: 1rem;">
                            <div class="form-group"
                                style="flex: 1; flex-direction: row; align-items: center; gap: 0.75rem; margin-bottom: 0;">
                                <input type="checkbox" id="hideNotesSymbol"
                                    style="width: 20px; height: 20px; cursor: pointer;">
                                <label for="hideNotesSymbol" style="cursor: pointer; margin-bottom: 0;">Hide
                                    Notes
                                    Symbol (Return to Plus Symbol Logic)</label>
                            </div>

                            <div class="form-group"
                                style="flex: 1; flex-direction: row; align-items: center; gap: 0.75rem; margin-bottom: 0;">
                                <input type="checkbox" id="showOnlyModal"
                                    style="width: 20px; height: 20px; cursor: pointer;">
                                <label for="showOnlyModal" style="cursor: pointer; margin-bottom: 0;">Show Only Modal
                                    Window (No Background Blur)</label>
                            </div>

                            <div class="form-group"
                                style="flex: 1; flex-direction: row; align-items: center; gap: 0.75rem; margin-bottom: 0;">
                                <input type="checkbox" id="editHistorySetting"
                                    style="width: 20px; height: 20px; cursor: pointer;">
                                <label for="editHistorySetting" style="cursor: pointer; margin-bottom: 0;">Move also
                                    edited records to history</label>
                            </div>

                            <div class="form-group" style="padding-top: 1rem; border-top: 1px solid var(--border);">
                                <label>Maintenance</label>
                                <div style="display: flex; gap: 1rem; align-items: center; margin-top: 0.5rem;">
                                    <button id="btnRecalculateWMA" class="btn-secondary" style="font-size: 0.9rem;">
                                        üîÑ Recalculate WMA Statistics
                                    </button>
                                    <p class="help-text"
                                        style="font-size: 0.8rem; color: var(--text-muted); margin: 0;">
                                        Calculates and saves WMA Age Marks and IAAF Points for all records to
                                        speed up
                                        reporting.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- DATA MANAGEMENT SUB-VIEW -->
                <div id="setting-data" class="setting-section setting-scroll hidden">
                    <div style="display: flex; gap: 1.5rem; margin-bottom: 2rem; align-items: stretch;">
                        <section class="card" style="flex: 1; margin-bottom: 0;">
                            <h2>Backup / Save Data</h2>
                            <p class="subtitle" style="margin-bottom: 1rem;">Save a copy of your database to your
                                program
                                folder.</p>
                            <button id="btnBackup" class="btn-primary"
                                style="background: linear-gradient(135deg, var(--success), #059669);">
                                <span>‚¨áÔ∏è Download Database (.json)</span>
                            </button>
                            <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">
                                Save this file as <code>track_data.json</code> in your program folder to keep it
                                safe.
                            </p>
                        </section>
                        <section class="card" style="flex: 1; margin-bottom: 0;">
                            <h2>Restore / Load Data</h2>
                            <p class="subtitle" style="margin-bottom: 1rem;">Select your saved file to restore your
                                data.
                            </p>
                            <div class="form-group">
                                <label for="fileRestore" style="margin-bottom: 0.5rem;">Select JSON File</label>
                                <input type="file" id="fileRestore" accept=".json"
                                    style="background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); padding: 0.5rem; border-radius: 8px; width: 100%;">
                            </div>
                            <button id="btnRestore" class="btn-secondary" style="width: 100%; margin-top: 1rem;">
                                <span>‚¨ÜÔ∏è Restore Database</span>
                            </button>
                        </section>
                    </div>
                    <section class="card" style="margin-top: 2rem;">
                        <h2>Import Records from Excel</h2>
                        <p class="subtitle" style="margin-bottom: 1rem;">Bulk upload records. First row must
                            contain
                            headers.</p>
                        <div style="margin-top: 1rem;">
                            <!-- File input: visually hidden but NOT display:none so label can trigger it -->
                            <input type="file" id="recordImportFile" accept=".xlsx, .xls"
                                style="opacity: 0; position: absolute; width: 1px; height: 1px; pointer-events: none;">
                            <div
                                style="display: flex !important; flex-direction: row !important; gap: 0.5rem; align-items: center; flex-wrap: nowrap !important;">
                                <button id="btnImportRecords" class="btn-primary"
                                    style="white-space: nowrap; width: auto !important; padding: 0.75rem 1.5rem; flex: 0 0 auto !important;">
                                    üì• Import Records (xls)
                                </button>
                                <button id="btnImportAthletes" class="btn-secondary"
                                    style="white-space: nowrap; width: auto !important; padding: 0.75rem 1.5rem; flex: 0 0 auto !important;">
                                    üìÅ Import Athletes
                                </button>
                                <input type="file" id="athleteImportFile" accept=".xlsx, .xls, .json" class="hidden">
                                <span id="recordImportFileName"
                                    style="font-size: 0.85rem; color: var(--primary); font-weight: 600; margin-left: 5px;"></span>
                            </div>
                        </div>

                        <div
                            style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px dashed var(--border); display: flex; align-items: center; gap: 1rem;">
                            <div style="flex: 1;">
                                <h3 style="margin-bottom: 0.25rem;">Data Recovery</h3>
                                <p class="subtitle" style="margin-bottom: 0;">Use this to restore missing DOBs from
                                    `restored_athletes.json`</p>
                            </div>
                            <label class="btn btn-secondary"
                                style="display: inline-block; cursor: pointer; white-space: nowrap; background: #ef44441a; border-color: #ef44444d; color: #ef4444;">
                                üöë Emergency Restore DOBs
                                <input type="file" id="fileRestoreDobs" accept=".json" style="display: none;"
                                    onchange="handleDobRestoration(event)">
                            </label>
                        </div>
                    </section>
                    <section class="card" style="margin-top: 2rem; border-color: rgba(239, 68, 68, 0.3);">
                        <h2 style="color: var(--danger);">Danger Zone</h2>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <button id="clearRecords" class="btn-text"
                                style="color: var(--danger); flex: 1; border: 1px solid var(--danger); padding: 1rem; border-radius: 12px;">
                                üóëÔ∏è Clear All Records Only
                            </button>
                            <button id="clearAthletes" class="btn-text"
                                style="color: var(--danger); flex: 1; border: 1px solid var(--danger); padding: 1rem; border-radius: 12px;">
                                üóëÔ∏è Clear All Athletes Only
                            </button>
                            <button id="clearAll" class="btn-text"
                                style="color: var(--danger); flex: 1; border: 1px solid var(--danger); padding: 1rem; border-radius: 12px;">
                                ‚ö†Ô∏è Factory Reset (Clear Everything)
                            </button>
                        </div>
                    </section>
                </div> <!-- End Setting Data -->
            </div> <!-- End View Settings -->

            <!-- JSON VIEWER VIEW -->


            <!-- HISTORY VIEW -->
            <div id="view-history" class="view-section">
                <section class="card">
                    <h2>Record History (Archive)</h2>
                    <p class="subtitle" style="margin-bottom: 1rem;">View and manage previous versions of edited
                        records.</p>
                    <div class="table-container">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th style="width: 40px;"></th>
                                    <th>Event</th>
                                    <th>Athlete</th>
                                    <th>Gender</th>
                                    <th>Age Group</th>
                                    <th style="text-align: center;">Mark</th>
                                    <th>IDR</th>
                                    <th>Wind</th>
                                    <th>Date</th>
                                    <th>Race Name</th>
                                    <th>User</th>
                                    <th>Archived At</th>
                                    <th class="actions-col">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="historyListBody">
                                <!-- History items injected here -->
                            </tbody>
                        </table>
                        <div id="historyEmptyState" class="empty-state hidden">
                            <p>No archived records found.</p>
                        </div>
                    </div>
                </section>
            </div>

            <!-- STATS VIEW -->
            <div id="view-stats" class="view-section">
                <!-- Sub Navigation (Card wrapper removed for space) -->
                <nav class="sub-nav" style="margin-bottom: 0.75rem;">
                    <button class="sub-tab stats-sub-tab active" data-stat-subtab="records-by-year">üìä Records by
                        Year</button>
                    <button class="sub-tab stats-sub-tab" data-stat-subtab="medals">National Holder
                        Statistics</button>
                    <button class="sub-tab stats-sub-tab" data-stat-subtab="wma">WMA Statistics</button>
                    <button class="sub-tab stats-sub-tab" data-stat-subtab="rankings">üèÜ Rankings</button>
                </nav>

                <!-- RECORDS BY YEAR SUB-VIEW -->
                <div id="stats-records-by-year" class="stats-section active-view">
                    <section class="card">
                        <div class="section-header">
                            <h2>Records Distribution by Year</h2>
                            <div class="actions-bar" style="margin-bottom: 0;">
                                <select id="yearChartType" class="form-control"
                                    style="width: auto; padding: 0.6rem 1rem; font-size: 1rem; font-weight: 600;"
                                    onchange="renderRecordsByYearChart(this.value)">
                                    <option value="bar" selected>Bar Chart</option>
                                    <option value="line">Line Chart</option>
                                </select>
                            </div>
                        </div>
                        <div style="flex: 1; min-height: 400px; position: relative;">
                            <canvas id="recordsByYearCanvas"></canvas>
                        </div>
                    </section>
                </div>

                <!-- MEDAL STATS SUB-VIEW -->
                <div id="stats-medals" class="stats-section">
                    <section class="card">
                        <div class="section-header">
                            <h2>National Holder Statistics</h2>
                        </div>
                        <div class="table-container">
                            <div class="filters"
                                style="display:flex; gap:10px; margin-bottom:10px; align-items:center;">
                                <select id="statsFilterName" class="form-control" style="width:200px;"
                                    onchange="renderStats()">
                                    <option value="all">All Athletes</option>
                                </select>
                                <select id="statsFilterGender" class="form-control" style="width:auto;"
                                    onchange="renderStats()">
                                    <option value="all">All Genders</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Mixed">Mixed</option>
                                </select>
                                <select id="statsFilterCategory" class="form-control" style="width:auto;"
                                    onchange="renderStats()">
                                    <option value="all">All Categories</option>
                                </select>
                                <select id="statsFilterMedal" class="form-control" style="width:auto;"
                                    onchange="renderStats()">
                                    <option value="all">All Ranks</option>
                                    <option value="gold">ü•á Gold</option>
                                    <option value="silver">ü•à Silver</option>
                                    <option value="bronze">ü•â Bronze</option>
                                    <option value="any">üèÖ Any Medal</option>
                                </select>
                                <select id="statsFilterTrackType" class="form-control" style="width:auto;"
                                    onchange="renderStats()">
                                    <option value="all">All Track Types</option>
                                    <option value="Outdoor">üèüÔ∏è Outdoor</option>
                                    <option value="Indoor">üè† Indoor</option>
                                </select>
                            </div>
                            <table class="report-table">
                                <thead>
                                    <tr>
                                        <th onclick="sortStats('generalRank')"
                                            style="width:7%; text-align:center; cursor:pointer;">Gen Rank ‚Üï</th>
                                        <th onclick="sortStats('name')" style="cursor:pointer; width:58%;">Athlete
                                            Name
                                            ‚Üï
                                        </th>
                                        <th onclick="sortStats('ratio')"
                                            style="cursor:pointer; width:10%; text-align:right;">
                                            Ratio % ‚Üï</th>
                                        <th onclick="sortStats('ageRank')"
                                            style="width:15%; text-align:right; cursor:pointer;">
                                            Age Rank (Medal) ‚Üï</th>
                                        <th onclick="sortStats('count')"
                                            style="cursor:pointer; width:10%; text-align:right;">
                                            Record Count ‚Üï</th>
                                    </tr>
                                </thead>
                                <tbody id="statsTableBody">
                                    <!-- Stats injected here -->
                                </tbody>
                            </table>
                        </div>
                    </section>
                </div> <!-- End Medal Stats -->

                <!-- WMA STATS SUB-VIEW -->
                <div id="stats-wma" class="stats-section">
                    <section class="card">
                        <div class="table-container">
                            <div class="wma-controls"
                                style="display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap; align-items:center; background:var(--bg-nav); padding:0.5rem 1rem; border-radius:12px; font-size: 0.9rem;">
                                <div class="form-group" style="flex:1; min-width:140px; margin-bottom:0;">
                                    <label style="font-size: 0.75rem; margin-bottom: 2px;">Event</label>
                                    <select id="wmaReportFilterEvent" class="form-control"
                                        style="padding: 4px 8px; height: auto;" onchange="renderWMAReport()">
                                        <option value="all">All Events</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex:1; min-width:140px; margin-bottom:0;">
                                    <label style="font-size: 0.75rem; margin-bottom: 2px;">Athlete</label>
                                    <select id="wmaReportFilterAthlete" class="form-control"
                                        style="padding: 4px 8px; height: auto;" onchange="renderWMAReport()">
                                        <option value="all">All Athletes</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex:1; min-width:100px; margin-bottom:0;">
                                    <label style="font-size: 0.75rem; margin-bottom: 2px;">Gender</label>
                                    <select id="wmaReportFilterGender" class="form-control"
                                        style="padding: 4px 8px; height: auto;" onchange="renderWMAReport()">
                                        <option value="all">All</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                        <option value="Mixed">Mixed</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex:1; min-width:100px; margin-bottom:0;">
                                    <label style="font-size: 0.75rem; margin-bottom: 2px;">Track</label>
                                    <select id="wmaReportFilterTrackType" class="form-control"
                                        style="padding: 4px 8px; height: auto;" onchange="renderWMAReport()">
                                        <option value="all">All</option>
                                        <option value="Outdoor">Outdoor</option>
                                        <option value="Indoor">Indoor</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex:1; min-width:100px; margin-bottom:0;">
                                    <label style="font-size: 0.75rem; margin-bottom: 2px;">Age</label>
                                    <select id="wmaReportFilterAgeGroup" class="form-control"
                                        style="padding: 4px 8px; height: auto;" onchange="renderWMAReport()">
                                        <option value="all">All</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex:1; min-width:80px; margin-bottom:0;">
                                    <label style="font-size: 0.75rem; margin-bottom: 2px;">Year</label>
                                    <select id="wmaReportFilterYear" class="form-control"
                                        style="padding: 4px 8px; height: auto;" onchange="renderWMAReport()">
                                        <option value="all">All</option>
                                    </select>
                                </div>
                            </div>
                            <table class="report-table">
                                <thead>
                                    <tr>
                                        <th onclick="sortWMAReport('event')" style="cursor:pointer">Event ‚Üï</th>
                                        <th onclick="sortWMAReport('athlete')" style="cursor:pointer">Athlete ‚Üï</th>
                                        <th onclick="sortWMAReport('gender')" style="cursor:pointer">Gender ‚Üï</th>
                                        <th onclick="sortWMAReport('age')" style="cursor:pointer">Age ‚Üï</th>
                                        <th onclick="sortWMAReport('mark')" style="cursor:pointer">Mark ‚Üï</th>
                                        <th onclick="sortWMAReport('idr')" style="cursor:pointer">IDR ‚Üï</th>
                                        <th onclick="sortWMAReport('rateConv')" style="cursor:pointer">RateConv ‚Üï
                                        </th>
                                        <th onclick="sortWMAReport('ageMark')" style="cursor:pointer">AgeMark ‚Üï</th>
                                        <th onclick="sortWMAReport('pts')" style="cursor:pointer">Pts ‚Üï</th>
                                        <th onclick="sortWMAReport('date')" style="cursor:pointer">Date ‚Üï</th>
                                        <th onclick="sortWMAReport('raceName')" style="cursor:pointer">Race Name ‚Üï
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="wmaReportBody">
                                    <!-- WMA Records injected here -->
                                </tbody>
                            </table>
                        </div>
                    </section>
                </div>

                <!-- RANKINGS SUB-VIEW -->
                <div id="stats-rankings" class="stats-section">
                    <section class="card">
                        <div class="section-header">
                            <h2>üèÜ WMA Points Rankings</h2>
                        </div>
                        <div class="table-container">
                            <div class="filters"
                                style="display:flex; gap:10px; margin-bottom:10px; align-items:center; flex-wrap:wrap;">
                                <select id="rankingsFilterName" class="form-control" style="width:200px;"
                                    onchange="renderRankings()">
                                    <option value="all">All Athletes</option>
                                </select>
                                <select id="rankingsFilterGender" class="form-control" style="width:auto;"
                                    onchange="renderRankings()">
                                    <option value="all">All Genders</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                </select>
                                <select id="rankingsFilterAgeGroup" class="form-control" style="width:auto;"
                                    onchange="renderRankings()">
                                    <option value="all">All Age Groups</option>
                                </select>
                                <select id="rankingsFilterTrackType" class="form-control" style="width:auto;"
                                    onchange="renderRankings()">
                                    <option value="all">All Tracks</option>
                                    <option value="Outdoor">Outdoor</option>
                                    <option value="Indoor">Indoor</option>
                                </select>
                            </div>
                            <table class="report-table">
                                <thead>
                                    <tr>
                                        <th onclick="sortRankings('rank')"
                                            style="cursor:pointer; width:6%; text-align:center;"># ‚Üï</th>
                                        <th onclick="sortRankings('name')" style="cursor:pointer;">Athlete ‚Üï</th>
                                        <th onclick="sortRankings('gender')" style="cursor:pointer; width:10%;">
                                            Gender ‚Üï
                                        </th>
                                        <th onclick="sortRankings('ageGroup')" style="cursor:pointer; width:12%;">
                                            Age
                                            Group ‚Üï</th>
                                        <th onclick="sortRankings('bestPts')"
                                            style="cursor:pointer; width:13%; text-align:right;">Best WMA Pts ‚Üï</th>
                                        <th onclick="sortRankings('avgPts')"
                                            style="cursor:pointer; width:13%; text-align:right;">Avg WMA Pts ‚Üï</th>
                                        <th onclick="sortRankings('count')"
                                            style="cursor:pointer; width:10%; text-align:right;">Records ‚Üï</th>
                                    </tr>
                                </thead>
                                <tbody id="rankingsTableBody">
                                    <!-- Rankings injected here -->
                                </tbody>
                            </table>
                        </div>
                    </section>
                </div>

            </div>
    </div>



    </main>
    </div>

    <!-- Libraries for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="font_data.js"></script>

    <!-- WMA Recalculation Progress Modal -->
    <div id="recalcModal" class="modal-overlay hidden">
        <div class="modal-content card" style="text-align: center; max-width: 400px;">
            <div class="spinner" style="margin: 0 auto 1.5rem;"></div>
            <h2 id="recalcTitle" style="margin-bottom: 0.5rem;">WMA Recalculation</h2>
            <p id="recalcStatus" class="subtitle" style="margin-bottom: 1.5rem;">Processing records...</p>

            <div class="progress-container">
                <div id="recalcProgressBar" class="progress-bar"></div>
            </div>

            <div id="recalcProgressText" class="progress-text" style="font-weight: 600; color: var(--primary);">0 / 0
                records</div>
        </div>
    </div>

    <!-- Formula Modal -->
    <div id="formulaModal" class="modal-overlay hidden">
        <div class="modal-content card">
            <h2>Parsing Formula</h2>
            <p class="subtitle" style="margin-bottom: 1rem; text-transform: none;">Set the rules for translating marks
                to values.</p>
            <div class="form-group">
                <label for="modalFormulaInput">Rule Definition</label>
                <textarea id="modalFormulaInput" rows="8"
                    style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 12px; padding: 0.75rem 1rem; color: var(--text-main); width: 100%; font-family: inherit; outline: none; transition: all 0.2s;"></textarea>
            </div>
            <div class="form-actions" style="justify-content: flex-end; margin-top: 1.5rem;">
                <button id="cancelFormulaBtn" class="btn-secondary" style="width: auto;">Cancel</button>
                <button id="saveFormulaBtn" class="btn-primary" style="width: auto;">OK</button>
            </div>
        </div>
    </div>

    <script src="xlsx.full.min.js"></script>
    <script>
        // Fallback: load from CDN if local file failed
        if (typeof XLSX === 'undefined') {
            document.write('<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"><\/script>');
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="data/wma_data_2023.js"></script>
    <script src="data/iaaf_data.js"></script>
    <script src="data/event_rules.js"></script>
    <script src="seed_data.js"></script>
    <script src="script.js"></script>

    <!-- Excel Import Step 1: Column Mapping Modal -->
    <div id="excelMappingModal"
        style="display:none; position:fixed; inset:0; background:rgba(15,23,42,0.7); z-index:2000; overflow-y:auto; backdrop-filter:blur(4px);">
        <div
            style="background:#f8fafc; max-width:860px; margin:3rem auto; border-radius:20px; overflow:hidden; box-shadow:0 25px 50px -12px rgba(0,0,0,0.4);">
            <div
                style="background:#fff; border-bottom:2px solid #e2e8f0; padding:1.5rem 2rem; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h2 style="margin:0; color:#1e1b4b; font-size:1.5rem;">Step 1: Column Mapping</h2>
                    <div style="color:#64748b; font-size:0.95rem; margin-top:0.3rem;">Select which Excel columns
                        correspond to each record field.</div>
                </div>
                <div style="display:flex; gap:0.75rem;">
                    <button onclick="document.getElementById('excelMappingModal').style.display='none'"
                        style="padding:0.65rem 1.4rem; border-radius:10px; border:none; background:#94a3b8; color:#fff; font-weight:700; cursor:pointer; font-family:inherit;">Cancel</button>
                    <button id="proceedToValidationBtn"
                        style="padding:0.65rem 1.4rem; border-radius:10px; border:none; background:#6366f1; color:#fff; font-weight:700; cursor:pointer; font-family:inherit; box-shadow:0 4px 6px -1px rgba(99,102,241,0.4);">Proceed
                        to Validation ‚Üí</button>
                </div>
            </div>
            <div style="padding:2rem;" id="excelMappingContent"></div>
        </div>
    </div>

    <!-- Excel Import Step 2: Validation Modal -->
    <div id="excelValidationModal"
        style="display:none; position:fixed; inset:0; background:rgba(15,23,42,0.7); z-index:2000; overflow-y:auto; backdrop-filter:blur(4px);">
        <div style="background:#fff; min-height:100vh;">
            <div id="excelValidationHeader"
                style="position:sticky; top:0; background:#fff; border-bottom:2px solid #e2e8f0; padding:1.25rem 2rem; display:flex; justify-content:space-between; align-items:center; box-shadow:0 4px 6px -1px rgba(0,0,0,0.05); z-index:100;">
                <div>
                    <h2 style="margin:0; color:#1e1b4b; font-size:1.5rem;">Step 2: Validation Preview</h2>
                    <div
                        style="font-size:0.9rem; color:#64748b; margin-top:0.25rem; display:flex; align-items:center; gap:1rem;">
                        <span id="valRecordCount"></span>
                        <label
                            style="cursor:pointer; font-weight:700; color:#dc2626; display:flex; align-items:center; gap:5px;">
                            <input type="checkbox" id="chkUnmatched" onchange="filterValidationRows()"
                                style="cursor:pointer; width:15px; height:15px;">
                            Show only unmatched
                        </label>
                    </div>
                </div>
                <div style="display:flex; gap:0.75rem;">
                    <button onclick="document.getElementById('excelValidationModal').style.display='none'"
                        style="padding:0.65rem 1.4rem; border-radius:10px; border:none; background:#94a3b8; color:#fff; font-weight:700; cursor:pointer; font-family:inherit;">Cancel</button>
                    <button id="completeImportBtn"
                        style="padding:0.65rem 1.4rem; border-radius:10px; border:none; background:#10b981; color:#fff; font-weight:700; cursor:pointer; font-family:inherit; box-shadow:0 4px 6px -1px rgba(16,185,129,0.4);">&#128229;
                        Complete Import</button>
                </div>
            </div>
            <div style="padding:2rem; overflow-x:auto;" id="excelValidationContent"></div>
        </div>
    </div>

</body>

</html>